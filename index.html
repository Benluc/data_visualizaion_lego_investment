<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="lib/css/vendor/bootstrap.min.css">
  <!-- Parcoords CSS -->
  <link rel="stylesheet" type="text/css" href="lib/css/vendor/parcoords.css">
  <!-- Main CSS -->
  <link rel="stylesheet" type="text/css" href="lib/css/style.css">
  <title>Lego Investigation</title>
</head>

<body>
  <div class="container">
    <div class="row">
      <h1>
        Lego Investment
        <small class="text-muted">is it worth to think about?</small>
      </h1>
    </div>
  </div>
  <hr class="mb-4">
  <div class="container">
    <div class="row">
      <div class="col-sm">
        <div class="well">observations:
          <span id="observationNumber">0</span>
        </div>
      </div>
      <div class="col-sm">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <label class="input-group-text" for="xAxis">x axis</label>
          </div>
          <select class="custom-select" id="xAxis">
            <option value="USRetailPrice">USRetailPrice</option>
            <option value="avgSellPrice">avgSellPrice</option>
            <option value="profit">profit</option>
            <option value="profitability">profitability</option>
            <option value="age" selected>age</option>
            <option value="parts">parts</option>
            <option value="weight">weight</option>
            <option value="boxSize">boxSize</option>
            <option value="minifigs">minifigs</option>
            <option value="offersByTotal">offersByTotal</option>
            <option value="wantedByTotal">wantedByTotal</option>
          </select>
        </div>
      </div>
      <div class="col-sm">
        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <label class="input-group-text" for="yAxis">y axis</label>
          </div>
          <select class="custom-select" id="yAxis">
            <option value="USRetailPrice">USRetailPrice</option>
            <option value="avgSellPrice">avgSellPrice</option>
            <option value="profit" selected>profit</option>
            <option value="profitability">profitability</option>
            <option value="age">age</option>
            <option value="parts">parts</option>
            <option value="weight">weight</option>
            <option value="boxSize">boxSize</option>
            <option value="minifigs">minifigs</option>
            <option value="offersByTotal">offersByTotal</option>
            <option value="wantedByTotal">wantedByTotal</option>
          </select>
        </div>
      </div>
      <div class="col-sm">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="regressionLine" checked>
          <label class="custom-control-label" for="regressionLine" data-delay='{"show":"500", "hide":"2000"}' data-toggle="tooltipInstruction"
            data-placement="top" data-html="true" title='<a href="https://en.wikipedia.org/wiki/Linear_regression" target="_blank">Linear regression</a> is a linear approach to modelling the relationship between a dependent variable (x axis) and one or more independent variables (y axis).'>regression
            <sup>?</sup>
          </label>
        </div>
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="scatterGrid" checked>
          <label class="custom-control-label" for="scatterGrid">grid</label>
        </div>
      </div>
      <div class="col-sm">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input" id="themeGroupColor">
          <label class="custom-control-label" for="themeGroupColor">themeGroup color</label>
        </div>
        <div class="slidecontainer">
          <input type="range" min="0" max="100" value="20" class="slider" id="opacitySlider">
          <label class="label" for="myRange" data-delay='{"show":"500", "hide":"2000"}' data-toggle="tooltipInstruction" data-placement="top"
            data-html="false" title='Lowering the opacity shows areas with high observation density.'>opacity
            <sup>?</sup>
          </label>
        </div>
      </div>
    </div>
  </div>
  <hr class="mb-4">
  <div class="container">
    <div class="row">
      <!-- <div class="col-sm">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <label class="input-group-text" for="xAxis">x axis</label>
                    </div>
                    <select class="custom-select" id="xAxis">
                      <option value="USRetailPrice">USRetailPrice</option>
                      <option value="avgSellPrice" >avgSellPrice</option>
                      <option value="profit" >profit</option>
                      <option value="profitability">profitability</option>
                      <option value="age" selected>age</option>
                      <option value="parts" >parts</option>
                      <option value="weight" >weight</option>
                      <option value="boxSize">boxSize</option>
                      <option value="minifigs">minifigs</option>
                      <option value="offersByTotal">offersByTotal</option>
                      <option value="wantedByTotal">wantedByTotal</option> 
                    </select>
                  </div>
                  <div class="input-group mb-3">
                    <div class="input-group-prepend">
                      <label class="input-group-text" for="yAxis">y axis</label>
                    </div>
                    <select class="custom-select" id="yAxis">
                      <option value="USRetailPrice">USRetailPrice</option>
                      <option value="avgSellPrice" >avgSellPrice</option>
                      <option value="profit" selected>profit</option>
                      <option value="profitability">profitability</option>
                      <option value="age">age</option>
                      <option value="parts" >parts</option>
                      <option value="weight" >weight</option>
                      <option value="boxSize">boxSize</option>
                      <option value="minifigs">minifigs</option>
                      <option value="offersByTotal">offersByTotal</option>
                      <option value="wantedByTotal">wantedByTotal</option> 
                    </select>
                  </div>
                  <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="regressionLine" checked>
                      <label class="custom-control-label" for="regressionLine">regression</label>
                    </div>
                    <div class="custom-control custom-checkbox">
                      <input type="checkbox" class="custom-control-input" id="scatterGrid" checked>
                      <label class="custom-control-label" for="scatterGrid">grid</label>
                    </div>
                    <div id="obLabel">amount:</div>
                    <div id="observationNumber">0</div>
            </div> -->
      <div class="col-sm">
        <label data-delay='{"show":"500", "hide":"2000"}' data-toggle="tooltipInstruction" data-placement="top" data-html="true"
          title='A <a href="https://en.wikipedia.org/wiki/Scatter_plot" target="_blank">scatterplot</a>  is a type of plot or mathematical diagram using Cartesian coordinates to display values for typically two variables for a set of data.'>Scatterplot
          <sup>?</sup>
        </label>
        <div id="scatter"></div>
      </div>
      <div class="col-sm">
        <label data-delay='{"show":"500", "hide":"2000"}' data-toggle="tooltipInstruction" data-placement="top" data-html="true"
          title='A <a href="https://en.wikipedia.org/wiki/Bubble_chart" target="_blank">bubble chart</a> is a type of chart that displays three dimensions of data.'>Bubble chart
          <sup>?</sup>
        </label>
        <div id="bubbleMatrix"></div>
      </div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div id="domainDrillDown"></div>
    </div>
  </div>
  <div class="container">
    <div class="row">
      <div class="col-sm">
        <h2>Usage</h2>
        <ol>
          <li>A point in the scatter plot or a line in the parallel coordinates represents one specific Lego Set.</li>
          <li>Using the parallel coordinates, the displayed data can be filtered by their variables. Click and drag a selection
            area on a variable axis. It's worth mentioning that you can drag and drop the position of the axes to better
            understand relationships between neighboring variables. The selection can be overridden by clicking above or below the selection area.</li>
          <li>Above the scatterplot is a control area. On the left side the currently displayed number of observations is shown.
            To the right of this one can project different variables onto the x or y axis of the scatterplot. Furthermore,
            readability can be improved by displaying or hiding the regression line, line raster, color by topic group and
            opacity of the data points.</li>
          <li>When hovering over a data point in the scatter plot, detailed information is shown, like the set number or the name. By clicking on a data point,
            it is marked and can be detected more easily with changes of the scatterplot. Click again to remove the markup.</li>
          <li>The bubble chart indicates the minimum, average, and maximum values ​​of a variable for each axis.</li>
        </ol>
      </div>
      <div class="col-sm">
        <h2>About</h2>
        <p>The project is part of a bachelor thesis about the potential of interactive data visualization for decision-making
          in alternative investment opportunities. The example of lego investment was to find out to what extent visualization
          can help to gain insights from a large amount of data. The data presented was extracted from bricklink.com and brickset.com
          from June 4, 2018 to June 8, 2018. Due to data errors and missing data, the presented data represents approximately
          25% of the total dataset of Lego Sets. 
          The Lego sets shown are from the years 1966-2017.
          A point in the scatter plot and a complete line in the parallel coordinates represents a Lego Set.
        </p>
        <p>
          For lack of data visualization experience, I opted for an explorative visualization approach to gain basic knowledge myself.
          The technical implementation is based to a large extent on the JavaScript library D3.js by Mike Bostock and should
          therefore be mentioned at this point. I hope the use of this tool is fun and leads to interesting insights. </p>
      </div>
    </div>
  </div>
  
  <div class="parallelCoordinates">
    &nbsp;
    <label data-delay='{"show":"500", "hide":"2000"}' data-toggle="tooltipInstruction" data-placement="top" data-html="true"
      title='A <a href="https://en.wikipedia.org/wiki/Parallel_coordinates" target="_blank">Parallel coordinates</a> are a common way of visualizing high-dimensional geometry and analyzing multivariate data.'>Parallel coordinates
      <sup>?</sup>
    </label>
    <div id="parallelCoordinates" class="parcoords">
    </div>
  </div>

  <!-- jQuery first, then Popper.js, then Bootstrap JS -->
  <script src="lib/js/vendor/jquery-3.3.1.slim.min.js"></script>
  <script src="lib/js/vendor/popper.min.js"></script>
  <script src="lib/js/vendor/bootstrap.min.js"></script>
  <!-- visualization related libaries -->
  <script src="lib/js/vendor/d3.v5.min.js"></script>
  <script src="lib/js/vendor/parcoords.standalone.js"></script>
  <script src="lib/js/vendor/underscore.js"></script>
  <!-- my libaries -->
  <script src="lib/js/scatterPlot.js"></script>
  <script src="lib/js/bubbleMatrix.js"></script>


  <script>
    
    /**********************************************/
    /* Defining and initializing global Variables */
    /**********************************************/
    var smallData;
    var parcoords = ParCoords( /*{nullValueSeparator: "bottom"}*/ )("#parallelCoordinates");
    var transparency = d3.scalePow()
      .exponent(0.15)
      .range([1, 1]);

    var colorList = ["#555555",
      "#7f7f7f",
      "#c49c94",
      "#9467bd",
      "#bcbd22",
      "#ff7f0e",
      "#e7ba52",
      "#dbdb8d",
      "#ffbb78",
      "#e377c2",
      "#c5b0d5",
      "#f7b6d2",
      "#17becf",
      "#8c564b",
      "#00ee99"
    ];
    var scatter = scatterPlot();
    var bMatrix = bubbleMatrix();

    // experimental (has something to do with the treemap)
    var testColor;
    

    /****************************/
    /* Initialize EventListener */
    /****************************/

    // Initialize tooltips
    $(function () {
      $('[data-toggle="tooltipInstruction"]').tooltip()
    })
    
    // Change axis variables
    d3.select("#xAxis").on("change", function (d, i) {
      scatter.changeDimension();
      bMatrix.setDimension();

    });
    d3.select("#yAxis").on("change", function (d, i) {
      scatter.changeDimension();
      bMatrix.setDimension();
    });
    // Change regression line
    d3.select("#regressionLine").on("change", function (d, i) {

      scatter.updateRegressionLine();
    })
    // Change line grid
    d3.select("#scatterGrid").on("change", function (d, i) {
      scatter.updateGrid();
    })
    // Change color
    d3.select("#themeGroupColor").on("change", function (d, i) {
      scatter.updateColor();
    })
    // Change opacity
    d3.select("#opacitySlider").on("change", function (d, i) {
      scatter.updateOpacity($("#opacitySlider").val());
    })


    /***************************************/
    /* Load csv file and create the charts */
    /***************************************/
    // d3.csv('data/tidyDataOutlier.csv').then(function (data) {
    d3.csv('data/tidyData.csv').then(function (data) {
      
      var colorMap = {};
      // map the defined colors to the theme groups
      
      _(data).chain()
        .pluck('themeGroup')
        .uniq()
        .each(function (d, i) {
          colorMap[d] = colorList.length > i ? colorList[i] : "black";
        });
      
      // Show number of observations
      $('#observationNumber').html(data.length);

      // experimental 
      testColor = colorMap;
      // Extract the colors
      var color = function (d) {
        return colorMap[d.themeGroup];
      };

      transparency.domain([1, data.length]);


      // Filter data
      smallData = data.map(function (d) {
        return {
          themeGroup: d.themeGroup,
          USRetailPrice: +d.USRetailPrice,
          avgSellPrice: +d.avgSellPrice,
          profit: +d.profit,
          profitability: +d.profitability,
          age: +d.age,
          parts: +d.parts,
          weight: +d.weight,
          boxSize: +d.boxSize,
          // packagingType: d.packagingType,
          //availability: d.availability,
          minifigs: +d.minifigs,
          offersByTotal: +d.offersByTotal,
          wantedByTotal: +d.wantedByTotal,
          name: d.name,
          set_num: d.set_num,
          year: d.year,
          theme: d.theme,
          subtheme: d.subtheme
        };
      });
      // Define dimensions that should be shown in paarCoords
      var dimensions = {
        "themeGroup": {
          orient: 'left',
          type: 'string',
        },
        "USRetailPrice": {
          title: "USRetailPrice ($)",
          type: "number"
        },
        "avgSellPrice": {
          title: "avgSellPrice ($)",
          type: "number"
        },
        "profit": {
          title: "profit ($)",
          type: "number"
        },
        "profitability": {
          title: "profitability (%)",
          type: "number"
        },
        "age": {
          title: "age (year)",
          type: "number"
        },
        "parts": {
          type: "number"
        },
        "weight": {
          title: "weight (g)",
          type: "number"
        },
        "boxSize": {
          title: "boxSize (cm^3)",
          type: "number"
        },
        "minifigs": {
          type: "number"
        },
        "offersByTotal": {
          type: "number"
        },
        "wantedByTotal": {
          type: "number"
        }
      };
      
      // Initialize the parallel coordinates
      parcoords
        .data(smallData)
        .dimensions(dimensions)
        .alpha(transparency(smallData.length))
        .color(color)
        .margin({
          top: 24,
          left: 100,
          bottom: 20,
          right: 60
        })
        .mode("queue")
        .render()
        .brushMode("1D-axes") // enable brushing
        .reorderable(); // enable reordering of axis
      
      // Initialize scatterplot and send the shared data
      scatter.data(smallData)("#scatter");
      // Initialize bubble chart and send the shared data
      bMatrix.data(smallData)("#bubbleMatrix");

      // Update data visualization on brush event
      parcoords.on("brush", function (d) {
        parcoords.alpha(transparency(d.length));
        scatter.show(d);
        bMatrix.show(d);
        $('#observationNumber').html(d.length);
      });
      
      // Resize parcoords on window resize
      window.onresize = function () {
        parcoords.width(document.body.clientWidth);
        parcoords.resize();
  
      };

      /**********************************************/
      /* TREEMAP                                    */
      /* Source: https://codepen.io/anon/pen/MBVQrK */
      /**********************************************/
      
      /* var data = data


      var margin = {
          top: 24,
          right: 0,
          bottom: 0,
          left: 0
        },
        width = 1200, //640
        height = 500,
        formatNumber = d3.format(",d"),
        transitioning;

      var x = d3.scaleLinear()
        .domain([0, width])
        .range([0, width]);

      var y = d3.scaleLinear()
        .domain([0, height - margin.top - margin.bottom])
        .range([0, height - margin.top - margin.bottom]);


      var color = d3.scaleOrdinal()
        .range(d3.schemeCategory10
          .map(function (c) {
            c = d3.rgb(c);
            c.opacity = 0.6;
            return c;
          }));




      var fader = function (color) {
        return d3.interpolateRgb(color, "#fff")(0.2);
      };
      var format = d3.format(",d");
      var treemap;
      var svg, grandparent;
      //var data = [];


      updateDrillDown();

      function updateDrillDown() {
        if (svg) {
          svg.selectAll("*").remove();
        } else {

          svg = d3.select("#domainDrillDown").append("svg")
            .attr("width", width - margin.left - margin.right)
            .attr("height", height - margin.bottom - margin.top)
            .style("margin-left", -margin.left + "px")
            .style("margin.right", -margin.right + "px")
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
            .style("shape-rendering", "crispEdges");

          grandparent = svg.append("g")
            .attr("class", "grandparent");

          grandparent.append("rect")
            .attr("y", -margin.top)
            .attr("width", width)
            .attr("height", margin.top);

          grandparent.append("text")
            .attr("x", 6)
            .attr("y", 6 - margin.top)
            .attr("dy", ".75em");

          treemap = d3.treemap()
            .tile(d3.treemapResquarify.ratio(height / width * 0.5 * (1 + Math.sqrt(5))))
            .size([width, height])
            .round(false)
            .paddingInner(1);
        }

        var nestedData = d3.nest()
          .key(function (d) {
            return "Tree Map";
          }) // root
          .key(function (d) {
            return d.themeGroup
          })
          .key(function (d) {
            return d.theme
          })
          .key(function (d) {
            return d.subtheme
          })
          .key(function (d) {
            return d.name + " | Setnummer: " + d.set_num
          })

          .entries(data);
        

        var lookup = d3.nest()
          .key(function (d) {
            return d.themeGroup + "-" + d.theme;
          })
          .rollup(function (leaves) {
            return leaves.length;
          })
          .object(data);

        var root2 = d3.hierarchy(nestedData[0], function (d, depth) {
            return d.values;
          })
          .sum(function (d) {
            return d.weight
          });

        var root = d3.hierarchy(nestedData[0], function (d, depth) {
            return d.values;
          })
          //.eachBefore(function(d) { d.id = (d.parent ? d.parent.id + "." : "") + d.data.key; })
          .sum((d) => d.profitability)
          .sort(function (a, b) {
            //console.log('initial root sort a ' + a.value + ' b ' + b.value);
            return b.height - a.height || b.value - a.value;
          });

        initialize(root);
        accumulate(root);
        layout(root);
        treemap(root);
        display(root);
      };

      function initialize(root) {
        root.x = root.y = 0;
        root.x1 = width;
        root.y1 = height;
        root.depth = 0;
      }

      // Aggregate the values for internal nodes. This is normally done by the
      // treemap layout, but not here because of our custom implementation.
      // We also take a snapshot of the original children (_children) to avoid
      // the children being overwritten when when layout is computed.
      function accumulate(d) {
        //console.log('accumulate called ' + d.data.name);
        return (d._children = d.children) ?
          d.value = d.children.reduce(function (p, v) {
            return p + accumulate(v);
          }, 0) : d.value;
      }

      // Compute the treemap layout recursively such that each group of siblings
      // uses the same size (1×1) rather than the dimensions of the parent cell.
      // This optimizes the layout for the current zoom state. Note that a wrapper
      // object is created for the parent node for each group of siblings so that
      // the parent’s dimensions are not discarded as we recurse. Since each group
      // of sibling was laid out in 1×1, we must rescale to fit using absolute
      // coordinates. This lets us use a viewport to zoom.
      function layout(d) {
        if (d._children) {
          //    treemap.nodes({_children: d._children});
          //	  treemap(d);
          d._children.forEach(function (c) {
            //c.x0 = d.x0 + c.x0 * (d.x1 - d.x0);
            //c.y0 = d.y0 + c.y0 * (d.y1 - d.y0);
            //c.x1 *= d.x1;
            //c.y1 *= d.y1;    
            c.x0 = d.x0 + c.x0 * d.x1;
            c.y0 = d.y0 + c.y0 * d.y1;
            c.x1 *= (d.x1 - d.x0);
            c.y1 *= (d.y1 - d.y0);
            c.parent = d;
            layout(c);
          });
        }
      }

      function display(d) {
        grandparent
          .datum(d.parent)
          .on("click", transition)
          .select("text")
          .text(name(d));

        var g1 = svg.insert("g", ".grandparent")
          .datum(d)
          .attr("class", "depth");

        var g = g1.selectAll("g")
          .data(d._children)
          .enter().append("g");

        g.filter(function (d) {
            return d._children;
          })
          .classed("children", true)
          .on("click", transition);

        var children = g.selectAll(".child")
          .data(function (d) {
            return d._children || [d];
          })
          .enter().append("g");

        children.append("rect")
          .attr("class", "child")
          .call(rect)
          .append("title")
          .text(function (d) {
            return d.data.key + " (" + formatNumber(d.value) + ")";
          });

        children.append("text")
          .attr("class", "ctext")
          .text(function (d) {
            return d.data.key;
          })
          .call(text2);

        g.append("rect")
          .attr("class", "parent")
          .call(rect);

        var t = g.append("text")
          .attr("class", "ptext")
          .attr("dy", ".75em")

        t.append("tspan")
          .text(function (d) {
            return d.data.key;
          });

        t.append("tspan")
          .attr("dy", "1.0em")
          .text(function (d) {
            return formatNumber(d.value);
          });

        t.call(text);
       
        g.selectAll("rect")
          .style("fill", function (d) {
            if (d.height == 4) {
              return testColor[d.data.key];
            } else {
              return color(d.value) 
            }
          });

        function transition(d) {
          if (transitioning || !d) return;

          
          transitioning = true;
          var g2 = display(d),
            t1 = g1.transition().duration(750),
            t2 = g2.transition().duration(750);

          // Update the domain only after entering new elements.
          //x.domain([d.x0, d.x0 + d.x1]);
          //y.domain([d.y0, d.y0 + d.y1]);
          x.domain([d.x0, d.x0 + (d.x1 - d.x0)]);
          y.domain([d.y0, d.y0 + (d.y1 - d.y0)]);

          // Enable anti-aliasing during the transition.
          svg.style("shape-rendering", null);

          // Draw child nodes on top of parent nodes.
          svg.selectAll(".depth").sort(function (a, b) {
            //console.log('.depth sort a ' + a.depth + ' b ' + b.depth);
            return a.depth - b.depth;
          });

          // Fade-in entering text.
          g2.selectAll("text").style("fill-opacity", 0);

          // Transition to the new view.
          t1.selectAll(".ptext").call(text).style("fill-opacity", 0);
          t2.selectAll(".ptext").call(text).style("fill-opacity", 1);
          t1.selectAll(".ctext").call(text2).style("fill-opacity", 0);
          t2.selectAll(".ctext").call(text2).style("fill-opacity", 1);
          t1.selectAll("rect").call(rect);
          t2.selectAll("rect").call(rect);

          // Remove the old node when the transition is finished.
          t1.remove().on("end", function () {
            svg.style("shape-rendering", "crispEdges");
            transitioning = false;
          });
        }
        return g;
      }

      function text(text) {
        text.selectAll("tspan")
          .attr("x", function (d) {
            return x(d.x0) + 6;
          })
        text.attr("x", function (d) {
            return x(d.x0) + 6;
          })
          .attr("y", function (d) {
            return y(d.y0) + 3;
          })
          .style("opacity", function (d) {
            var w = x(d.x1) - x(d.x0);
            //console.log("text opacity setting textlength " + this.getComputedTextLength() + " d size " + w);
            return this.getComputedTextLength() < w - 6 ? 1 : 0;
          });
      }

      function text2(text) {
        text.attr("x", function (d) {
            return x(d.x1) - this.getComputedTextLength() - 6;
          })
          .attr("y", function (d) {
            return y(d.y1) - 6;
          })
          .style("opacity", function (d) {
            var w = x(d.x1) - x(d.x0);
            //console.log("text2 opacity setting textlength " + this.getComputedTextLength() + " d size " + w);
            return this.getComputedTextLength() < w - 6 ? 1 : 0;
          });
      }

      function rect(rect) {
        rect.attr("x", function (d) {
            return x(d.x0);
          })
          .attr("y", function (d) {
            return y(d.y0);
          })
          .attr("width", function (d) {
            var w = x(d.x1) - x(d.x0);
            //console.log('id ' + d.id +' rect width ' + w);
            return w;
          })
          .attr("height", function (d) {
            var h = y(d.y1) - y(d.y0);
            //console.log('id ' + d.id +' rect height ' + h);
            return h;
          });
      }

      function name(d) {
        return d.parent ? name(d.parent) + " / " + d.data.key + " (" + formatNumber(d.value) + ")" : d.data.key +
          " (" + formatNumber(d.value) + ")";
      } */


    });
  </script>
</body>

</html>
